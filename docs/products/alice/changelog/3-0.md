---
title : AliceScript 3.0の新機能
summary : この記事では、AliceScript3.0の変更点と新機能について説明します
date : 2023-12-23
order : 8
---
## 新機能
AliceScript 3.0(Alice3.0)は、[Alice2.3](./2-3.md)の後継です。
Alice3.0では、.NETやネイティブの機能との相互運用性がさらに向上しました。

最新のAliceScriptADKは[AliceScriptのダウンロード](../download.md)でダウンロードできます。

!!!note "フィードバック"
    AliceScriptの新機能に関するご意見や不具合がある場合、[Losetta](https://github.com/WSOFT-Project/Losetta)リポジトリにお寄せください。

### 関数関係
#### 戻り値の型指定
関数のシグネチャに戻り値の型を記述することで、その関数がどんな値を返すかを明らかにできます。次の例をご覧ください。

```cs title="AliceScript"
string GetUserName()
{
    return "UserName"; //文字列を返す
}

string BadFunc()
{
    return 0; //戻り値の型が異なるためエラー
}

void SubRoutine()
{
    return; //戻り値を返さない(暗黙的にvoidを返している)
}
```
#### 参照渡し
関数内で引数の値を変更し、その変更を呼び出し元にも反映できます。AliceScriptでは`ref`キーワードを使用することで、参照渡しであることが明らかになり、間違いを防げます。
次に例を示します。

```cs title="AliceScript"
void Increment(ref number num)
{
    num++;
}

var i = 0;
Increment(ref i);
print(i); //出力 : 2
```

#### 拡張メソッド
任意の型について、拡張メソッドを実装できるようになりました。
また、拡張メソッドとしてのみ呼び出せるようにする`extonly`キーワードを導入しました。
次に例を示します。

```cs title="AliceScript"
void Output(this string str)
{
    print(str);
}

string s = "Hello,World";
Output(s);  //通常の関数として呼び出し
s.Output(); //拡張メソッドとして呼び出し

extonly number Pow(this number a)
{
    return a * a;
}

number n = 2;
n.Pow(); //拡張メソッドとして呼び出し
Pow(n);  //これはエラー
```

#### 関数の外部実装
外部で実装された関数をAliceScriptで使用するには、`extern`キーワードを使用して関数を宣言します。

次の例では、.NETで実装されている[System.Console.WriteLine](https://learn.microsoft.com/en-us/dotnet/api/system.console.writeline)メソッドを使用してコンソールにメッセージを表示します。

```cs title="AliceScript"
#netimport "System.Console","System.Console"
extern void WriteLine(string text);

WriteLine("Hello,World");
```

また、次の例では、Win32APIで定義されている[MessageBox](https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messagebox)関数を使用してメッセージを表示します。

```cs title="AliceScript"
#libimport "user32.dll"
extern int MessageBox(HWND hwnd,LPCSTR lpText,LPCTSTR lpCaption,UINT uType);

MessageBox(0,"Hello,World!","TestMessage",0);
```

### 文字列リテラル関係
#### UTF-8リテラル
文字列リテラルの先頭に`u8`を追加することで、文字列をUTF-8バイナリの形式で表現できます。次の例をご覧ください。

```cs title="AliceScript"
var str = u8"ABC";
print(str.Type);//出力:BYTES
```

#### 文字列補間
文字列補間を使用すると、文字列を連結して結果を表示する代わりに文字列中で式の結果を使用できます。次の例をご覧ください。

```cs title="AliceScript"
print($"2 + 3 = {2+3}");//出力:2 + 3 = 5
```

#### エスケープ文字
新しいエスケープ文字`\e`を使用すると、ANSI X.364を用いてコンソールでさまざまな効果を表現できます。次の例では、コンソールでテキストを赤い文字でを表示しています。

```cs title="AliceScript"
print("\e[31mHello,World");
```

#### Unicodeエスケープシーケンス
Unicodeエスケープシーケンスを使用すると、任意のUnicode文字をコードポイントを使って表記できます。次の例をご覧ください。

```cs title="AliceScript"
// `N`のUnicodeコードポイントはU+0004e

print("\u004e");     //出力 : N  (\uXXXX)4ケタ
print("\U0000004e"); //出力 : N  (\Uxxxxxxxx)8ケタ
print("\x4e");       //出力 : N  (\xXX)1～4ケタ
```

### 数値リテラル関係
#### 8進数リテラル
数値リテラルの先頭に`0o`を追加することで8進数で数値を表現できます。次の例をご覧ください。

```cs title="AliceScript"
var num = 1234;//10進数リテラル
print(num);//出力:1234

num = 0o2322;
print(num);//出力:123
```

#### 数値区切り文字
桁数が大きな数値リテラルを見やすく表現するため、リテラルの先頭と終端、小数点の前後以外の任意の場所にアンダースコア(`_`)を使用できます。次の例をご覧ください。

```cs title="AliceScript"
var num = 1_234_567;

num = 0x_12D_687;

num = _12_3;//これはエラーになる

num = 12._3;//これもエラーになる
```

## 言語の変更
- [#40](https://github.com/WSOFT-Project/Losetta/issues/40) `throw`式が引数として`Exception`オブジェクトも受け入れるように
- 関数およびメソッドの引数で参照渡しができるように
- `array[^1]`とすることで配列の特定番目の要素を逆から指定できるように
- `catch`ブロックでオブジェクトが不要な場合省略可能に
- 前処理指令で設定を直接変更できるように
- `case`ブロックを複数一致のORに対応
- 前置インクリメント・デクリメント演算子を導入
- 簡易的な静的型付けを導入
- `block`文を導入
- `variable`型指定修飾を導入
- 空の文を表現できるように
- `readonly`構文を実装
- 関数の外部定義に対応
- `null`条件演算子を実装
- #100 スプレッド構文を実装
- #101 ユーザーが名前空間を自由に定義できるように
- #104 関数の事前条件および事後条件の表明の実装
- #105 関数定義の短絡表記をオーバーライド時にも使用できるように
- #106 関数の定義方法の変更
- #107 型キーワードを省略した拡張メソッドを実装できるように
- UnicodeのFormat文字はすべて無視するように

## 実装の変更
- デバッグ出力のインデントに使用される文字をを空白文字4つに変更
- デバッグ出力の表示色を白色から水色に変更
- REPLで呼び出し履歴（スタックトレース）が表示されるように
- ARM版macOS(M1Mac)をネイティブサポート
- 可能な場合スタックトレースの文字列表現に名前空間を表示するように
- パス設定用のスクリプトを生成するように
- スクリプトのパフォーマンス向上
- `alice`で例外発生時に式を挿入できるように
- C#のchar型との相互変換を実装
- 別の場所にあるアセンブリを読み込めるように
- 構文エラー時に表示されるエラーを改善

## APIの変更
- `env_lang_name`関数と`env_lang_version`関数を追加
- `file_read_codepage`関数を実装
- `file_write_text`と`file_append_text`でコードページ番号を指定して書き込めるように
- より安全にファイルを読み書きできる`file_write_encrypt`と`file_read_decrypt`を実装
- `exit`関数を丸括弧なしで呼び出せるように変更
- `bytes.ToString(number codePage)`で文字コードを指定して文字列化できるように
- `bytes.ToBase64`を実装
- 文字列や配列の拡張メソッド追加
- スクリプトから直接ParsingScriptを制御できるように
- DNS関連の関数実装
- 対数関数(`Math_Log`)、逆数の近似値を求める関数(`Math_ReciprocalEstimate`)、階乗を求める関数(`Math_Factorial`)を実装
- 表明関連の関数を実装
- `string.PadCenter`関数を実装
- `ProcessInfo`オブジェクトで終了コードをとれるように
- 数値丸め処理APIのオプションを追加

## APIの不具合の修正
- env_expand_environmentVariablesの引数の文字列が`null`の場合に例外が発生する不具合の修正